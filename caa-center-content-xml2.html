<div class="row center-content">
    <div class="filter-column">
        <div class="filters">
            <div class="filter-text clearfix" id="name-search">
                <p class="filter-list-title" >Search by Name</p>
                <input type="text" id="text-input" class="filter-text-input" />
            </div>
            <div class="filter-vocab">
                <div class="data-filter-header">
                    <h4>Additional Filters</h4>
                    <span class="label-desc">Click to expand.</span>
                </div>
                <div id="filter-terms"></div>
                <div id="filter-cultures"></div>
            </div>
        </div>
    </div>
    <div class="col artists">
        <div class="content-header">
            <h1>CPL&rsquo;s Chicago Artists File</h1>
            <p id="helper-text">Please search for an artist by name, or select filters from the left.</p>
        </div>
        <div class="results-target" id="results"></div>
        <div id="intro-text">Intro text.  Lorem ipsum dolor sit amet consectetur adipisicing elit. Quae totam repudiandae quo esse reprehenderit, minus dolorum! Repellendus alias consequatur pariatur repudiandae, minus error? Nostrum, perferendis blanditiis dignissimos eveniet vel necessitatibus.</div>
    </div>
</div> 
</div>

<script>
    var caaArtists, caaArtTerms, caaCultures, count = 0;
    var $caaArtists, $caaArtTerms, $caaCultures;
    $.when(
        $.get('caa-artists.xml').done(function(xml){
            caaArtists = $(xml);
            // var result = $(xml).find("artist[accNumber=9]").attr('name');
            // console.log(result);
        }).fail(function(xml, textStatus, errorThrown){
            console.log("caaArtists error: " + errorThrown);
        }),
        $.get("caa-artTerms.xml").done(function(xml) {
            caaArtTerms = $(xml);
        }).fail(function(xml, textStatus, errorThrown){
            console.log(" artTerms error: "  + errorThrown);
        }),
        $.get("caa-cultures.xml").done(function(xml) {
            caaCultures = $(xml);
        }).fail(function(xml, textStatus, errorThrown){
            console.log("cultures error; " + errorThrown);
        })
    ).then(function(){
            $('#name-search').append('<button class="go-button" id="goButton" onClick="goButton()">Go</button>' +
                    '<button class="go-button float-right" onClick="clearFilters()" id="clearFilters">Clear Filters</button>');
            $('#filter-terms').append('<h5 class="clickable-title" onClick="toggleFilterList(\'filter-terms-toplevel\')">Filter by Medium</h5>' +
                '<ul class="filter-list" id="filter-terms-toplevel" style="display: none"></ul>');
            $('#filter-cultures').append('<h5 class="clickable-title" onClick="toggleFilterList(\'filter-culture-toplevel\')">Filter by Cultural Affiliation</h5>' + 
                '<ul class="filter-list" id="filter-culture-toplevel" style="display: none"></ul>');
            $('artTerm', caaArtTerms).each(function(){
                var id = $(this).attr('id'),
                    name = $(this).find('name').text();
                $('#filter-terms-toplevel').append('<li data-sort="' + id + '" class="caa-filter">' +
                            '<input name="contentFilter" type="checkbox" id="filter-type-'  + id + '" class="filter-terms" value="'  + id + '">' + 
                            '<label for="filter-type-'  + id + '"> '  + name + '</label>' + 
                    '</li>');
            });            $('culture', caaCultures).each(function(){
                var id = $(this).attr('id'),
                    name = $(this).find('name').text();
                $('#filter-culture-toplevel').append('<li data-sort="' + id + '" class="caa-filter">' +
                            '<input name="contentFilter" type="checkbox" id="filter-type-'  + id + '" class="filter-cultures" value="'  + id + '">' + 
                            '<label for="filter-type-'  + id + '"> '  + name + '</label>' + 
                    '</li>');
            });
            $('#text-input').keypress(function(e){
                if(e.keyCode==13)
                    goButton();
            });
    });
    var cultures = [
                {"group": "mistakes", "name": "Mistakes & Inconsistencies", "ids": ["Columbia","Colombian","German","Painting","Germany (?)","Korean","Moroccan","Native America","Philpino","Italian","Ukranian","African America","Armenian","Bulgarian"]},
                {"group": "americas", "name":"Americas" , "ids": ["Venezuela","Franco-American","Chile","Haiti","Inca","Guatamala","Panama Canal Zone","Dominican Republic","Colombia","Nicaragua","Italian American","Mestizo","African American","Mexico","Afro-Hispanic","apache","Belize","Puerto Rico","Argentina","Canada","Brazil","Jamaica","Hispanic","Navajo","Cuba","Native American"]},
                {"group": "africa",  "name":"Africa & ME", "ids" : ["Nigeria","South Africa","Cameroon","Egypt","Sudan","Tunisia","Morocco","Israel","Iran","Iraq","Afghanistan"]},
                {"group": "asia", "name":"Asia & Pacific Islands", "ids": ["China","Hawaii","Japan","South Korea","Taiwan","Korea","Philippines","Hong Kong","Nepal","India","Vietnam","Indonesia","Bangladesh","Asian / Pacific Islander" ]},
                {"group": "europe",  "name":"Europe", "ids": ["Belgium","British","Bohemia","Turkey","Serbia","Estonia","Moravia","Georgia","Netherlands","Bulgaria","Germany","Luxembourg","Cyprus","Poland","Latvia","Wales","Basque","Belarus","Switzerland","Holland","Lithuania","Scotland","Armenia","Greece","Sweden","Russia","Italy","Yugoslavia","Romania","Spain","Denmark","Ireland","Ukraine","Austria","England","Czechoslovakia","France","Norway","Hungary"]},
                {"group": "religions",  "name":"Religions & Ethnicities", "ids": ["Jewish","Christian","Muslim"]}];
    function goButton(){
        input = $('#text-input').val();
        if (input.length > 0 ){
            masterFilter();
        }
    }
    function clearFilters(){
        $('input[type=checkbox]').prop('checked',false); 
        $('#text-input').val('');
        clearCenter();
        $('#helper-text').empty().append('Please search for an artist by name, or select filters from the left.');
    }
    function clearCenter(){
        $('#helper-text').empty();
        $('#results').empty();
        $('#intro-text').empty();
    }   
    function toggleFilterList(list){
        $('#' + list).slideToggle().sortElements('li');
    }
    jQuery.fn.sortElements = function sortElements(el) {
        $('> ' + el , this[0]).sort(dec_sort).appendTo(this[0]);
        function dec_sort(a, b){ return ($(b).data('sort')) < ($(a).data('sort')) ? 1 : -1; }
    }
    function masterFilter(){
        var resultsXml = [];
        var filteredArtistIds = dataFilter(caaArtists);
        // console.log(filteredArtistIds);
        if (filteredArtistIds.length > 0 ){
            for (var i in filteredArtistIds){
                var arti = caaArtists.find('artists > artist[id=' + filteredArtistIds[i] + ']');
                if ( textFilter(arti) ) {
                    resultsXml.push(arti);
                }
            }    
        } else if ( $('input:checked').length ) {
            clearCenter();
            $('#helper-text').empty().append('No results.  Try widening your search.');
            return false;
        } else {
            caaArtists.find('artist').each(function(){
                if ( textFilter(this) ) {
                    resultsXml.push(this);
                }
            });
        }
        htmlify(resultsXml);
    }
    function dataFilter(xml){
        filterTerms = $('#filter-terms-toplevel').find(':checkbox:checked').map(function () {
            return $(this).attr('value');
        }).get();
        filterCultures = $('#filter-culture-toplevel').find(':checkbox:checked').map(function () {
            return $(this).attr('value');
        }).get();
        if (filterTerms.length === 0 && filterCultures.length === 0 && $('#text-input').val().length === 0) {
            clearCenter();
        }
        var idList = [],
            termsUniqueIdList = [],
            culturesUniqueIdList = [],
            filteredIds = [],
            uniqueFilteredIds = [];
        for ( var f in filterTerms){
            caaArtTerms.find('artTerm[id=' + filterTerms[f] + '] > id').each( function(val){
                idList.push($(this).text());
            });
         
        }
        termsUniqueIdList = idList.slice().sort(function(a,b){return a > b}).reduce(function(a,b){if (a.slice(-1)[0] !== b) a.push(b);return a;},[]);
        idList = [];
        for ( var f in filterCultures){
            caaCultures.find('culture[id=' + filterCultures[f] + '] > id').each( function(val){
                idList.push($(this).text());
            });
        }
        culturesUniqueIdList = idList.slice().sort(function(a,b){return a > b}).reduce(function(a,b){if (a.slice(-1)[0] !== b) a.push(b);return a;},[]);
        // $('#helper-text').empty().append("cultures: " +  "; terms: " + termsUniqueIdList); 
        if (culturesUniqueIdList.length > 0 && termsUniqueIdList.length > 0 ) {
            filteredIds = termsUniqueIdList.filter(function(element) {
                return culturesUniqueIdList.indexOf(element) !== -1;
            });
        } else {
            filteredIds = termsUniqueIdList.concat(culturesUniqueIdList);
        }
        uniqueFilteredIds = filteredIds.reduce(function(a,b){
            if (a.indexOf(b) < 0 ) a.push(b);
                return a;
        },[]);
        return uniqueFilteredIds;
    }
    function textFilter(xml){
        input = $('#text-input').val();
        var haystack = $(xml).find('name').text();
        if (( haystack && haystack.toUpperCase().indexOf(input.toUpperCase()) > -1 ) || input.length < 1 ){
            // console.log("its true");
            return true;
        }
    }
    function htmlify(xml){
        console.log(xml);
        var htmlifiedXml = [];
            // citations = [];
        // function citationify(monographs){
        // }
        count = 0;
        for (var x in xml ){
            count++;
            var name = $(xml[x]).find('name').text(), 
                id = $(xml[x]).find('id').text(), 
                dob = $(xml[x]).find('dob').text(), 
                dod = $(xml[x]).find('dod').text(), 
                gender = $(xml[x]).find('gender').text(), 
                file = $(xml[x]).find('file').text(), 
                slides = $(xml[x]).find('slides').text(), 
                videos = $(xml[x]).find('videos').text(), 
                resume = $(xml[x]).find('resume').text(), 
                artistsstatement = $(xml[x]).find('artistsstatement').text(), 
                gallerynotice = $(xml[x]).find('gallerynotice').text(), 
                article = $(xml[x]).find('article').text(), 
                poster = $(xml[x]).find('poster').text(), 
                folio = $(xml[x]).find('folio').text(), 
                cdrom = $(xml[x]).find('cdrom').text(), 
                mediums = '',
                cultures = '',
                citations = [],
                sorter = name.replace(/[|&;$%@"<>()-+, ]/g, "").toLowerCase();
            $(xml[x]).find('monographs').find('monograph').each(function(){
                if($(this).attr('error') === "TRUE"){
                    console.log($(this).attr('errorType'));
                    citations += "";
                } else {
                    var firstName = $(this).find('firstName').text(), 
                        lastName = $(this).find('lastName').text(), 
                        name = firstName + ' ' + lastName, 
                        title = $(this).find('title').text(), 
                        callNo = $(this).find('callNo').text(), 
                        url = 'http://chipublib.bibliocommons.com/search?custom_query=callnumber%3A%28%22' + callNo + '*%22%29';
                    // <monograph callNumber="N11.C5Y6" title="Role and impact : the Chicago Society of Artists" lastName="Yochim" firstName="Louise Dunn" year="1979" />
                        citations += '<li><a href="' + url + '">' + title + '</a> By ' + name + '</li>';
                }
            });
            $(xml[x]).find('mediums').find('medium').each(function(){
                var bumper = '';
                if (mediums != ''){
                    bumper = ', ';
                }
                mediums += bumper + $(this).text();
            });
            $(xml[x]).find('cultures').find('culture').each(function(){
                var bumper = '';
                if (cultures != ''){
                    bumper = ', ';
                }
                cultures += bumper + $(this).text();
            });
            htmlifiedXml.push('<div class="artist" data-sort="' + sorter + '"><h2 class="artist-name">' + name + '</h2>' +
            ( dob != '' || dod != '' ? '<p class="artist-details">' + dob + '-' + dod + '</p>' : '') +
            ( gender != '' ? '<p class="artist-details">Gender: ' + gender + '</p>' : '' ) +
            ( mediums != '' ? '<p class="artist-details">Medium(s): ' + mediums + '</p>' : '' ) +
            ( cultures != '' ? '<p class="caa-contents-header">Cultural Affiliations: ' + cultures + '</p>' : '' ) +
            '<p class="caa-contents-header">Chicago Artists File Contents: <ul class="caa-contents-list">' + 
            '<li >File: ' + ( file === 'TRUE' ? 'Yes' : 'No') + '</li>' +
            '<li >Slides: ' + ( slides === 'TRUE' ? 'Yes' : 'No') + '</li>' +
            '<li >Videos: ' + ( videos === 'TRUE' ? 'Yes' : 'No') + '</li>' +
            ( artistsstatement === 'TRUE' ? '<li>Artist&rsquo;s Statement: Yes </li>' : '' ) +
            ( gallerynotice === 'TRUE' ? '<li>Gallery Notice(s): Yes </li>' : '' ) +
            ( article === 'TRUE' ? '<li>Article(s): ' + article + ' </li>' : '' ) +
            ( poster === 'TRUE' ? '<li>Poster(s): Yes </li>' : '' ) +
            ( folio === 'TRUE' ? '<li>Folio(s): Yes </li>' : '' ) +
            ( cdrom === 'TRUE' ? '<li>CD-ROM(s): Yes </li>' : '' ) +
            '</ul>' +
            ( citations.length > 0 ? '<p class="artist-citations">Citations from the CPL Collection:</p><ul>' + citations : '') + 
            '</ul></div>');
        }
        appendResults(htmlifiedXml);
    }
    function appendResults(results){
        clearCenter();
        $('#helper-text').append(count + " results.")
        $('#results').empty().append(results).sortElements('div');
    }
</script>